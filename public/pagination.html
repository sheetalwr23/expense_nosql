<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expense</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>
  <style>
    .logOut {
      float: right;
      margin: 10px;
    }

    .tb-body {
      background-color: rgb(239, 245, 247);
    }
  </style>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" />

</head>

<body>
  <div><a href="./index.html"><button class="btn btn-info logOut">LogOut</button></a></div>
  </div>
  </div>
  </div>
  </div>
  </nav>
  <div class="container-fluid">
    <div class="container my-4">
      <div class="row text-start my-4">
        <div class="col-12" id="currentdate"></div>
      </div>
      <div class="row ">
        <div class="col-12 fs-3" id="currentyear"></div>
      </div>
      <div class="row ">
        <div class="col-12 fs-3" id="currentmonth"></div>
      </div>
      <div class="row ">
        <div class="col-12">
          <div class="table-responsive tb-body">
            <table class="table">
              <thead>
                <tr class="border">

                  <th id="cat">Amount</th>
                  <th id="amt">Desciption</th>
                  <th id="del">Category</th>
                </tr>
              </thead>
              <tbody id="pagination-content"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-center mt-3">
        <div class="me-4 mt-2">
          <label for="custompagination">Rows per page</label>
          <select value="select" name="pagination" id="custompagination">
            <option selected value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <button id="prev-btn">Previous</button>
        <button id="next-btn">Next</button>
      </div>
      <div id="data"></div>
      <div class="row">
        <div class="col-12 d-flex justify-content-end my-5">
          <a href="#" class="btn-slide2" onclick="download()" id="downloadexpense">
            <span class="circle2 text-center"><i class="fa fa-download"></i></span>
            <span class="title2">Download</span>
            <span class="title-hover2">Click here</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>

    let currentPage = 1; // Current page
    let totalPages = 0; // Total number of pages (calculate based on data length and page size)

    function updateRowPerPage() {
      const rowperpage = parseInt(document.getElementById('custompagination').value);
      return rowperpage;
    }

    async function updatePaginationTable(page) {
      try {

        const token = localStorage.getItem("token");
        const pageSize = parseInt(document.getElementById('custompagination').value); // Get page size here
        const response = await axios.get(
          `http://localhost:3000/expense?page=${page}&limit=${pageSize}`,
          {
            headers: { Authorization: token },
          }
        );
        console.log(response);
        const data = response.data.expense;
        console.log("data", data)
        const tableBody = document.getElementById("pagination-content");
        tableBody.innerHTML = "";

        data.forEach((object) => {
          const row = document.createElement("tr");

          const amountCell = document.createElement("td");
          amountCell.textContent = object.amount;
          row.appendChild(amountCell);

          const descCell = document.createElement("td");
          descCell.textContent = object.description;
          row.appendChild(descCell);

          const categoryCell = document.createElement("td");
          categoryCell.textContent = object.category;
          row.appendChild(categoryCell);


          tableBody.appendChild(row);
          const deletebutton = document.createElement("button");
          deletebutton.type = "button";
          deletebutton.textContent = "Delete";
          // deletebutton.style.color = "black";
          // deletebutton.style.marginTop = "5px";
          // (deletebutton.style.marginLeft = "15px"),
          // (deletebutton.style.padding = "5px");
          deletebutton.classList.add("btn", "btn-info");
          row.appendChild(deletebutton);
          deletebutton.onclick = async () => {
            try {
              const token = localStorage.getItem("token");
              const response = await axios.delete(
                `http://localhost:3000/expense/${object._id}`,
                { headers: { Authorization: token } }
              );
              tableBody.removeChild(row);
            } catch (error) {
              console.log(error);
            }
          };
          tableBody.appendChild(row);
        });

        const pageInfo = document.getElementById("page-info");
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

        document.getElementById("prev-btn").disabled = currentPage === 1;
        document.getElementById("next-btn").disabled = currentPage === totalPages;

      } catch (error) {
        console.log("err", error);
      }
    }

    document.getElementById('custompagination').addEventListener('change', () => {
      currentPage = 1; // Reset to first page when changing rows per page
      updateTotalPages();
    });

    document.getElementById('prev-btn').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        updatePaginationTable(currentPage);
      }
    });

    document.getElementById('next-btn').addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        updatePaginationTable(currentPage);
      }
    });


    async function updateTotalPages() {
      try {
        const token = localStorage.getItem("token");
        const response = await axios.get(
          "http://localhost:3000/expense",
          {
            headers: { Authorization: token },
          }
        );
        console.log("get res", response.data.expense.length);


        const totalItems = response.data.expense.length;
        const pageSize = updateRowPerPage();
        totalPages = Math.ceil(totalItems / pageSize);

        updatePaginationTable(currentPage);
      } catch (error) {
        console.log(error);
      }
    }

    document.getElementById("prev-btn").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        updatePaginationTable(currentPage);
      }
    });

    document.getElementById("next-btn").addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        updatePaginationTable(currentPage);
      }
    });

    updateTotalPages();

    function download() {

      const token = localStorage.getItem("token"); // Retrieve the token from localStorage
      axios
        .get("http://localhost:3000/download", {
          headers: { Authorization: token },
        })
        .then((response) => {
          if (response.status === 201) {
            var a = document.createElement("a");
            a.href = response.data.fileUrl;
            a.download = "myexpense.csv";
            a.click();
          } else {
            throw new Error(response.data.message);
          }
        })
        .catch((err) => {
          showError(err);
        });
    }



    function getCurrentYear() {
      return new Date().getFullYear();
    }

    // Function to get the current month
    function getCurrentMonth() {
      const options = { month: "long" };
      return new Date().toLocaleDateString(undefined, options);
    }

    function getCurrentDate() {
      const options = {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      };
      return new Date().toLocaleDateString(undefined, options);
    }

    function updateDivContent(divId, content) {
      const div = document.getElementById(divId);
      div.style.fontWeight = "bold";
      div.style.fontSize = "16px";
      div.textContent = content;
    }

    // Event listener for when the page has finished loading
    window.addEventListener("load", () => {
      updateDivContent("currentdate", getCurrentDate());
      updateDivContent("currentyear", getCurrentYear());
      updateDivContent("currentmonth", getCurrentMonth());
    });
  </script>
</body>

</html>